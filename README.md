# TAK Mumble TLS Helper

A general-purpose Bash script to configure **TLS certificates for Mumble (mumble-server / Murmur)** in TAK ecosystems (e.g., ATAK/WinTAK + TAK Voice/VX plugin using Mumble).

It supports:
- **Lab/offline** environments using an existing **OpenTAKServer (OTS) CA**
- Environments that need a quick **local CA**
- **Production/public** environments using **Let’s Encrypt** (Certbot) with automated renewals

---

## Why this exists

TAK Voice / VX (Mumble client) often fails when:
- the server presents a **self-signed** or **autogenerated** certificate
- the certificate does not contain the correct **SAN** (IP or DNS)
- the service cannot read the private key due to **permissions**

This script standardizes certificate issuance and deployment to Mumble.

---

## What the script does

Depending on the selected mode, the script will:

1. Generate or obtain a TLS certificate for the Mumble server
2. Install it into:
   - `/etc/mumble/server.key`
   - `/etc/mumble/server_chain.crt`
   - `/etc/mumble/ca.pem` (for `ots-ca` / `self-ca`)
3. Update `/etc/mumble/mumble-server.ini`:
   - `sslCert=/etc/mumble/server_chain.crt`
   - `sslKey=/etc/mumble/server.key`
   - `port=<your_port>`
4. Restart the `mumble-server` systemd service (when available)
5. Create a Certbot deploy hook in Let’s Encrypt mode so renewals keep working

---

## Requirements

### OS
- Ubuntu (systemd-based). Tested on typical Ubuntu setups running `mumble-server`.

### Packages
- `openssl` (installed automatically if missing)
- `certbot` (installed automatically in Let’s Encrypt mode)

### Permissions
- Must be run with **root privileges**:
  ```bash
  sudo ./tak_mumble_tls.sh ...
  ```

---

## Certificate SAN rules (important)

Clients validate the certificate **against the address they used to connect**.

- If clients connect using **IP** (e.g., `192.168.0.14`), your cert must include:
  - `SAN: IP:192.168.0.14`

- If clients connect using **FQDN** (e.g., `voice.example.com`), your cert must include:
  - `SAN: DNS:voice.example.com`

> **Let’s Encrypt cannot issue certificates for IP addresses.**  
> If you need IP-based connections, use `ots-ca` or `self-ca`.

---

## Installation

1. Place the script in your repo:
   ```bash
   chmod +x tak_mumble_tls.sh
   ```

2. Ensure Mumble uses:
   - `/etc/mumble/mumble-server.ini`  
   - `mumble-server` systemd service

You can confirm with:
```bash
systemctl cat mumble-server
```

---

## Usage

### 1) Mode: `ots-ca` (recommended for labs with OpenTAKServer)

Use an existing OTS CA directory that contains:
- `ca-do-not-share.key`
- `ca-trusted.pem` (preferred) OR `ca.pem`

**IP-only lab**
```bash
sudo ./tak_mumble_tls.sh --mode ots-ca --ip 192.168.0.14
```

**FQDN + IP**
```bash
sudo ./tak_mumble_tls.sh --mode ots-ca --fqdn mumble.lab.local --ip 192.168.0.14
```

**Custom OTS CA path**
```bash
sudo ./tak_mumble_tls.sh --mode ots-ca --ip 192.168.0.14 --ots-ca-dir /home/ubuntu/ots/ca
```

---

### 2) Mode: `self-ca` (no OTS CA available)

Creates a local CA (default: `/etc/mumble/ca`) and signs a server cert.

```bash
sudo ./tak_mumble_tls.sh --mode self-ca --ip 192.168.0.14
```

The CA certificate is stored at:
- `/etc/mumble/ca/ca.crt`

You must import this CA into your TAK clients (ATAK/WinTAK/VX) as a trusted CA.

---

### 3) Mode: `letsencrypt` (production / public FQDN)

**HTTP-01** challenge requires inbound TCP **80** to the host running Certbot.
```bash
sudo ./tak_mumble_tls.sh --mode letsencrypt \
  --fqdn voice.example.com \
  --email admin@example.com \
  --challenge http
```

**DNS-01** challenge requires you to create a DNS TXT record during issuance:
```bash
sudo ./tak_mumble_tls.sh --mode letsencrypt \
  --fqdn voice.example.com \
  --email admin@example.com \
  --challenge dns
```

This mode also installs a deploy hook:
- `/etc/letsencrypt/renewal-hooks/deploy/mumble-server.sh`

So renewals will automatically:
- copy the renewed cert/key into `/etc/mumble/`
- restart `mumble-server`

> Use Let’s Encrypt only when your clients connect via **FQDN** (DNS).  
> Let’s Encrypt will not include an IP SAN.

---

## Verifying the deployed certificate

### 1) Confirm INI values
```bash
sudo grep -nE '^(sslCert|sslKey|port)=' /etc/mumble/mumble-server.ini
```

### 2) Confirm service is listening
```bash
sudo ss -lntp | grep 64738
sudo ss -lunp | grep 64738
```

### 3) Test TLS handshake (lab CA)
For `ots-ca` mode:
```bash
CA=/home/ubuntu/ots/ca/ca-trusted.pem
[ -f "$CA" ] || CA=/home/ubuntu/ots/ca/ca.pem

openssl s_client -connect 192.168.0.14:64738 -servername 192.168.0.14 -CAfile "$CA" </dev/null \
  | openssl x509 -noout -subject -issuer -dates
```

For `self-ca` mode:
```bash
CA=/etc/mumble/ca/ca.crt
openssl s_client -connect 192.168.0.14:64738 -servername 192.168.0.14 -CAfile "$CA" </dev/null \
  | openssl x509 -noout -subject -issuer -dates
```

---

## Client-side notes (ATAK / VX)

If the server certificate is valid but the client shows **unknown CA**:
- import the CA certificate into the device/app trust store:
  - `ots-ca`: `ca-trusted.pem` or `ca.pem`
  - `self-ca`: `/etc/mumble/ca/ca.crt`

If you connect by **IP**, ensure the certificate SAN includes that IP.  
If you connect by **FQDN**, ensure the certificate SAN includes that DNS name.

---

## Troubleshooting

### The server still shows “Autogenerated Certificate”
Check if `sslCert` and `sslKey` are empty or incorrect in:
- `/etc/mumble/mumble-server.ini`

Then restart:
```bash
sudo systemctl restart mumble-server
```

### `openssl s_client` returns “connection refused”
- Wait a second after restart and re-test
- Verify the service is listening:
  ```bash
  sudo ss -lntp | grep 64738
  ```
- Inspect logs:
  ```bash
  sudo journalctl -u mumble-server -b --no-pager | tail -n 200
  ```

### “Permission denied” reading the key
Mumble often runs as `mumble-server`. Ensure:
```bash
sudo chown root:mumble-server /etc/mumble/server.key
sudo chmod 640 /etc/mumble/server.key
sudo systemctl restart mumble-server
```

### Clients connect but voice drops
Make sure UDP is open on the Mumble port:
- TCP 64738 is for control
- UDP 64738 is typically used for voice packets

If UFW is enabled:
```bash
sudo ufw allow 64738/tcp
sudo ufw allow 64738/udp
```

---

## Security considerations

- In `ots-ca` mode, the script uses your OTS CA private key:
  - `ca-do-not-share.key`
  Treat this key as highly sensitive.
- In Let’s Encrypt mode, the script copies `privkey.pem` into `/etc/mumble/server.key`
  so the `mumble-server` user can read it. This is required for many systemd deployments.

---

## License

This project is licensed under the **GNU General Public License v3.0 or later (GPL-3.0-or-later)**.
